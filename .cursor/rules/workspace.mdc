---
description: Rules for the workspace package (agents, tools, RPC, runtime).
globs: packages/workspace/**/*
alwaysApply: true
---

## Structure

- **RPC**: Router in `src/rpc/index.ts` (app, message, project, registry, runtime, session). Handlers in `src/rpc/routes/`. Base and `toORPCError` in `src/rpc/base.ts`. Exposed to Studio as `workspaceRouter` via `@quests/workspace/electron`.
- **Tools**: `src/tools/`. Each tool is built with `setupTool()` from `create-tool.ts`; register in `all.ts`. Use neverthrow `Result` for fallible tool logic; map to tool output or throw for oRPC.
- **Agents**: `src/agents/`. `main` and `retrieval` in `all.ts`. Main agent runs the session; tools are selected per agent in `create-agent.ts`.
- **Workspace server**: Hono app in `src/logic/server/index.ts`. Serves shim script/iframe, assets, heartbeat, redirect, and proxies app traffic. AI gateway is mounted at `AI_GATEWAY_API_PATH` when provided.
- **Schemas**: `src/schemas/` (paths, subdomains, store-id, session, app-state, file-upload, etc.). Use these for RPC and tool I/O where applicable.
- **Machines**: XState in `src/machines/` (workspace, session, agent). `WorkspaceActorRef` is the main process handle; RPC context gets `workspaceRef` and `workspaceConfig`.

## Conventions

- Prefer neverthrow `Result` for fallible operations; use `toORPCError` when throwing from RPC handlers.
- Tools use Zod input/output schemas and the shared `create-tool` / `setupTool` pattern.
